#!/bin/bash
set -e

echo "ğŸ“¦ MariaDB ì„¤ì¹˜ ìë™í™” ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘"

# --- OS ê°ì§€ ---
if [ -f /etc/os-release ]; then
    . /etc/os-release
    DISTRO_ID=$ID
    ID_LIKE=${ID_LIKE,,}
else
    echo "âŒ OS ì •ë³´ë¥¼ ê°ì§€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
    exit 1
fi

# --- ì„¤ì¹˜ ì—¬ë¶€ í™•ì¸ ---
if command -v mysql >/dev/null 2>&1; then
    CURRENT_VER=$(mysql --version | grep -oP 'Distrib \K[0-9.]+')
    echo "âœ… ì´ë¯¸ ì„¤ì¹˜ëœ MariaDB ë²„ì „: $CURRENT_VER"
    exit 0
fi

# --- ì•ˆì • ë²„ì „ ëª©ë¡ ê²€ìƒ‰ (í‘œì‹œë§Œ) ---
echo "ğŸ” ì„¤ì¹˜ ê°€ëŠ¥í•œ ì•ˆì • ë²„ì „ ëª©ë¡ (í‘œì‹œìš©):"
curl -s https://mariadb.org/download/ | grep -Eo '10\.[0-9]+\.[0-9]+' | sort -u | head -n 5

# --- Debian ê³„ì—´ ---
if [[ "$ID_LIKE" == *"debian"* ]]; then
    echo "ğŸŸ¢ Debian ê³„ì—´ ê°ì§€ë¨: $DISTRO_ID"

    sudo apt-get update -y
    sudo apt-get install -y curl gnupg lsb-release

    echo "ğŸŒ MariaDB ì €ì¥ì†Œ ë“±ë¡"
    curl -LsS https://r.mariadb.com/downloads/mariadb_repo_setup | sudo bash

    sudo apt-get update -y
    sudo apt-get install -y mariadb-server mariadb-client

# --- RHEL ê³„ì—´ ---
elif [[ "$ID_LIKE" == *"rhel"* || "$DISTRO_ID" =~ ^(rocky|almalinux|centos)$ ]]; then
    echo "ğŸ”´ RHEL ê³„ì—´ ê°ì§€ë¨: $DISTRO_ID"

    sudo dnf -y install curl policycoreutils
    curl -LsS https://r.mariadb.com/downloads/mariadb_repo_setup | sudo bash

    sudo dnf -y install MariaDB-server MariaDB-client

else
    echo "âŒ ì´ ë°°í¬íŒì€ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤: $DISTRO_ID"
    exit 1
fi

# --- ì„œë¹„ìŠ¤ ì‹œì‘ ë° í™•ì¸ ---
sudo systemctl enable --now mariadb
echo "âœ… MariaDB ì„œë¹„ìŠ¤ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤."
mysql --version
